<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fake-X 2.0 (refatorado mobile/touch)</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#007BFF">
  <link rel="icon" href="./icons/praxis.png" type="image/png">
  <link rel="apple-touch-icon" href="./icons/icon-180.png" sizes="180x180">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
  <style>
    :root {
      --primary: #007BFF;
      --primary-dark: #0056b3;
      --accent: #5e6ad2;
      --danger: #e53935;
      --bg-light: linear-gradient(135deg, #f5f7fa, #c3cfe2);
      --text-light: #333;
      --radius: 12px;
      --gap: 10px;
      --transition: 0.2s ease;
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      display: flex; flex-direction: column; align-items: center;
      min-height: 100dvh; padding: 16px 16px 92px; /* espa√ßo para barra fixa */
      gap: 12px;
    }

    h2 { font-size: clamp(1.25rem, 1rem + 2vw, 2rem); }
    .sub { font-size: .95rem; opacity: .85; margin-bottom: 4px; text-align: center; }

    /* √Årea 4:5 sempre responsiva (preview), exportaremos em 1080x1350 via scale */
    #exportArea {
      width: min(92vw, 540px);
      aspect-ratio: 4 / 5; /* 1080x1350 */
      display: grid; place-items: center; position: relative;
    }

    #tweetContainer {
      width: 94%; max-width: 520px; background: #fff; border-radius: 30px; box-shadow: 0 6px 24px rgba(0,0,0,.08);
      padding: 12px; overflow: hidden;
    }

    #tweetHeader { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
    #tweetHeader img { width: 56px; height: 56px; border-radius: 50%; object-fit: cover; border: 2px solid #eee; }
    #tweetHeader h1 { font-size: clamp(18px, 2.4vw + 12px, 26px); }
    #tweetHeader p { font-size: clamp(12px, 2vw + 8px, 15px); opacity: .8; }

    #tweetText {
      font-size: 20px; line-height: 1.45; padding: 10px; border: 1px dashed transparent; min-height: 64px; white-space: pre-wrap; word-wrap: break-word;
      -webkit-user-select: text; user-select: text;
    }
    #tweetText:focus { border-color:#aaa; outline: none; }
    #tweetText:empty::before { content: attr(placeholder); color:#bbb; }

    #charCount { font-size: .9rem; color:#555; text-align: center; }

    /* √Årea de imagens */
    #mediaArea { display: none; gap: 8px; margin-top: 8px; }
    #mediaArea.one { display: block; }
    #mediaArea.two { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }

    .imgBox {
      position: relative; width: 100%; aspect-ratio: 1 / 1; background:#f3f3f3; border-radius: 14px; overflow: hidden; border:1px solid #eee;
      background-image: none; background-size: cover; background-position: 50% 50%; background-repeat: no-repeat;
      touch-action: none; /* habilita gestos sem scroll */
    }
    .badge { position: absolute; top: 6px; left: 6px; background: rgba(0,0,0,.55); color:#fff; padding: 4px 6px; font-size: .75rem; border-radius: 6px; }

    /* Barra fixa inferior (mobile-first) */
    .dock {
      position: fixed; inset: auto 0 0 0; background: rgba(255,255,255,.9); backdrop-filter: saturate(1.2) blur(6px);
      border-top: 1px solid #e7e7e7; display: flex; gap: 8px; padding: 10px env(safe-area-inset-right) 10px env(safe-area-inset-left);
      justify-content: center; flex-wrap: wrap;
    }
    .btn { display: inline-flex; align-items: center; gap: 8px; padding: 10px 14px; border: none; border-radius: 999px; cursor: pointer; font-weight: 600; font-size: 15px; transition: transform var(--transition), background var(--transition); }
    .btn:active { transform: translateY(1px); }
    .btn.primary { background: var(--primary); color: #fff; }
    .btn.primary:hover { background: var(--primary-dark); }
    .btn.accent { background: var(--accent); color: #fff; }
    .btn.ghost { background: #fff; color:#333; border:1px solid #e6e6e6; }
    .btn.danger { background: var(--danger); color: #fff; }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; justify-content: center; }
    select, input[type="range"] { border-radius: 999px; padding: 8px 12px; border:1px solid #ddd; }

    .segmented { display: inline-flex; background:#fff; border:1px solid #ddd; border-radius:999px; overflow:hidden; }
    .segmented button { border:0; background:transparent; padding:8px 12px; font-weight:600; cursor:pointer; }
    .segmented button[aria-pressed="true"] { background:#111; color:#fff; }

    @media (min-width: 740px) {
      body { padding-bottom: 24px; }
      .dock { position: static; backdrop-filter:none; border:0; background:transparent; justify-content: center; }
    }
  </style>
</head>
<body>
  <h2>Fake-X</h2>
  <div class="sub">v2.0 ‚Äî Upload de at√© 2 imagens, gestos de pin√ßa/arraste, export 4:5 para Instagram</div>

  <div class="row">
    <select id="userSelect" aria-label="Selecionar perfil">
      <option value="cida">Cida Pedrosa</option>
      <option value="enl">Esquerda na Luta</option>
      <option value="omao">O Mundo Aqui</option>
      <option value="antibolso">AntiBolsonaro</option>
      <option value="absurda">Absurdamente</option>
      <option value="soudeesquerda">Sou de Esquerda</option>
      <option value="luciana">Luciana Santos</option>
      <option value="mjn">Minha Joia News</option>
      <option value="joaopaulo">Jo√£o Paulo ‚≠ê</option>
    </select>
    <div class="segmented" role="group" aria-label="Layout de imagens">
      <button id="oneImg" aria-pressed="true">1 imagem</button>
      <button id="twoImg" aria-pressed="false">2 imagens</button>
    </div>
    <label class="btn ghost" for="imgInput">Adicionar imagem(ens)</label>
    <input id="imgInput" type="file" accept="image/*" multiple hidden />
    <button id="clearImages" class="btn danger">Limpar</button>
  </div>

  <div class="row" style="margin-top: -4px;">
    <button data-cmd="bold" class="btn ghost"><strong>B</strong></button>
    <button data-cmd="underline" class="btn ghost"><u>U</u></button>
    <label for="fontSizeSelect">Fonte</label>
    <select id="fontSizeSelect">
      <option value="16px">Mt. Pequeno</option>
      <option value="18px">Pequeno</option>
      <option value="20px" selected>Normal</option>
      <option value="22px">Grande</option>
      <option value="24px">Mt. Grande</option>
    </select>
  </div>

  <!-- Preview 4:5 responsivo -->
  <div id="exportArea">
    <div id="tweetContainer">
      <div id="tweetHeader">
        <img id="profileImg" src="" alt="Foto de perfil">
        <div>
          <h1 id="profileName"></h1>
          <p id="profileHandle"></p>
        </div>
      </div>

      <div id="tweetText" contenteditable placeholder="Escreva seu texto aqui..."></div>

      <div id="mediaArea" class="one">
        <div id="box1" class="imgBox"><span class="badge">1</span></div>
        <div id="box2" class="imgBox" style="display:none"><span class="badge">2</span></div>
      </div>
    </div>
  </div>

  <div id="charCount">340 caracteres restantes</div>

  <div class="dock">
    <div class="row">
      <button id="fitAll" class="btn accent">Ajustar imagem(s)</button>
      <button id="downloadBtn" class="btn primary">Baixar PNG 4:5</button>
      <button id="tipsBtn" class="btn ghost">Dicas</button>
    </div>
  </div>

  <script>
    const tweetText = document.getElementById('tweetText');
    const charCount = document.getElementById('charCount');
    const downloadBtn = document.getElementById('downloadBtn');
    const fontSizeSelect = document.getElementById('fontSizeSelect');
    const toolbarBtns = document.querySelectorAll('[data-cmd]');
    const profileImg = document.getElementById('profileImg');
    const profileName = document.getElementById('profileName');
    const profileHandle = document.getElementById('profileHandle');
    const userSelect = document.getElementById('userSelect');

    const imgInput = document.getElementById('imgInput');
    const box1 = document.getElementById('box1');
    const box2 = document.getElementById('box2');
    const mediaArea = document.getElementById('mediaArea');
    const clearImagesBtn = document.getElementById('clearImages');
    const oneImgBtn = document.getElementById('oneImg');
    const twoImgBtn = document.getElementById('twoImg');
    const fitAllBtn = document.getElementById('fitAll');
    const tipsBtn = document.getElementById('tipsBtn');

    const maxChars = 340;

    const profiles = {
      cida: { name: 'Cida Pedrosaüåª', handle: '@cidapedrosa65', img: 'foto_perfil.jpg' },
      enl: { name: 'Esquerda na Luta', handle: '@esquerdanaluta', img: 'imgNaLuta.png' },
      omao: { name: 'O Mundo Aqui Oficial', handle: '@omundoaquioficial', img: 'omundoaqui.png' },
      antibolso: { name: 'AntiBolsonaro', handle: '@antibolsonaroreal', img: 'antibolsoimg.jpeg' },
      absurda: { name: 'Absurdamente Cotidiano', handle: '@absurdamentecotidiano', img: 'absurda.jpg' },
      soudeesquerda: { name: 'Sou de Esquerda', handle: '@soudeesquerda_', img: 'profileSDE.jpeg' },
      luciana: { name: 'Luciana Santos', handle: '@lucianasantos', img: 'profileLucianaSantos.jpg' },
      mjn: { name: 'Minha Joia News', handle: '@minhajoianews', img: 'profileMJN.png' },
      joaopaulo: { name: 'Jo√£o Paulo ‚≠ê', handle: '@joaopaulodopt', img: 'profileJoaoPaulo.jpg' }
    };

    function loadProfile(key) {
      const profile = profiles[key];
      if (profile) {
        profileImg.src = profile.img; profileName.textContent = profile.name; profileHandle.textContent = profile.handle;
      }
    }

    function placeCaretAtEnd(el) {
      el.focus(); const r = document.createRange(); r.selectNodeContents(el); r.collapse(false);
      const s = window.getSelection(); s.removeAllRanges(); s.addRange(r);
    }

    function updateText() {
      let text = tweetText.textContent;
      if (text.length > maxChars) { tweetText.textContent = text.slice(0, maxChars); placeCaretAtEnd(tweetText); }
      charCount.textContent = `${maxChars - tweetText.textContent.length} caracteres restantes`;
      downloadBtn.disabled = !(tweetText.textContent.trim() || imgState[1].loaded || imgState[2].loaded);
    }

    toolbarBtns.forEach(btn => btn.addEventListener('click', () => { document.execCommand(btn.dataset.cmd); updateText(); }));
    fontSizeSelect.addEventListener('change', () => { tweetText.style.fontSize = fontSizeSelect.value; });
    tweetText.addEventListener('input', updateText);
    userSelect.addEventListener('change', () => loadProfile(userSelect.value));

    // ====== IMAGENS com Pointer Events (arraste + pin√ßa) ======
    let imgState = {
      1: { loaded:false, size:120, posX:50, posY:50 },
      2: { loaded:false, size:120, posX:50, posY:50 },
    };

    function applyBackground(box, idx) {
      const st = imgState[idx]; if (!st.loaded) return;
      box.style.backgroundSize = `${st.size}% auto`;
      box.style.backgroundPosition = `${st.posX}% ${st.posY}%`;
    }

    function fitImage(idx) { imgState[idx].size=100; imgState[idx].posX=50; imgState[idx].posY=50; applyBackground(idx===1?box1:box2, idx); }
    function fitAll() { if(imgState[1].loaded) fitImage(1); if(imgState[2].loaded) fitImage(2); }

    function setupGesture(box, idx) {
      const pointers = new Map();
      let start = { posX: imgState[idx].posX, posY: imgState[idx].posY, size: imgState[idx].size };
      let baseDist = 0;

      const onPointerDown = (e) => {
        box.setPointerCapture(e.pointerId);
        pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
        start = { posX: imgState[idx].posX, posY: imgState[idx].posY, size: imgState[idx].size };
      };

      const onPointerMove = (e) => {
        if (!pointers.has(e.pointerId)) return;
        pointers.set(e.pointerId, { x: e.clientX, y: e.clientY });
        const pts = Array.from(pointers.values());
        const rect = box.getBoundingClientRect();

        if (pts.length === 1) {
          const dx = ((pts[0].x - Array.from(pointers.keys())[0] /* dummy */), e.movementX) || 0; // fallback para desktops
        }

        if (pts.length === 1) {
          // Arraste em %
          const last = pts[0];
          const prev = last; // usamos movementX/Y para suavizar
          const dx = (e.movementX / rect.width) * 100;
          const dy = (e.movementY / rect.height) * 100;
          imgState[idx].posX = Math.max(0, Math.min(100, imgState[idx].posX + dx));
          imgState[idx].posY = Math.max(0, Math.min(100, imgState[idx].posY + dy));
          applyBackground(box, idx);
        } else if (pts.length >= 2) {
          // Pin√ßa: calcula dist√¢ncia entre os dois primeiros dedos
          const [p1, p2] = pts;
          const dist = Math.hypot(p2.x - p1.x, p2.y - p1.y);
          if (!baseDist) baseDist = dist;
          const scale = dist / baseDist;
          imgState[idx].size = Math.max(80, Math.min(400, start.size * scale));
          applyBackground(box, idx);
        }
      };

      const onPointerUp = (e) => {
        pointers.delete(e.pointerId);
        if (pointers.size < 2) baseDist = 0;
      };

      box.addEventListener('pointerdown', onPointerDown);
      box.addEventListener('pointermove', onPointerMove);
      box.addEventListener('pointerup', onPointerUp);
      box.addEventListener('pointercancel', onPointerUp);
      box.addEventListener('dblclick', () => fitImage(idx)); // double-tap desktop
    }

    function refreshMediaLayout() {
      const count = (imgState[1].loaded?1:0) + (imgState[2].loaded?1:0);
      if (twoImgBtn.getAttribute('aria-pressed') === 'true') {
        // for√ßa layout 2 se usu√°rio quiser
        mediaArea.className = 'two'; box2.style.display = 'block'; mediaArea.style.display = 'grid';
      } else if (count === 0) {
        mediaArea.style.display = 'none'; box2.style.display = 'none';
      } else if (count === 1) {
        mediaArea.className = 'one'; box2.style.display = 'none'; mediaArea.style.display = 'block';
      } else {
        mediaArea.className = 'two'; box2.style.display = 'block'; mediaArea.style.display = 'grid';
      }
      updateText();
    }

    function loadImageToBox(file, box, idx) {
      const reader = new FileReader();
      reader.onload = e => {
        box.style.backgroundImage = `url('${e.target.result}')`;
        imgState[idx].loaded = true; imgState[idx].size = 120; imgState[idx].posX = 50; imgState[idx].posY = 50;
        applyBackground(box, idx); refreshMediaLayout();
      };
      reader.readAsDataURL(file);
    }

    imgInput.addEventListener('change', () => {
      const files = Array.from(imgInput.files).slice(0,2);
      if (files[0]) loadImageToBox(files[0], box1, 1);
      if (files[1]) loadImageToBox(files[1], box2, 2);
    });

    clearImagesBtn.addEventListener('click', ()=>{
      [1,2].forEach(i=>{ imgState[i] = { loaded:false, size:120, posX:50, posY:50 }; });
      box1.style.backgroundImage = ''; box2.style.backgroundImage='';
      refreshMediaLayout();
    });

    oneImgBtn.addEventListener('click', ()=>{ oneImgBtn.setAttribute('aria-pressed','true'); twoImgBtn.setAttribute('aria-pressed','false'); refreshMediaLayout(); });
    twoImgBtn.addEventListener('click', ()=>{ twoImgBtn.setAttribute('aria-pressed','true'); oneImgBtn.setAttribute('aria-pressed','false'); refreshMediaLayout(); });

    fitAllBtn.addEventListener('click', fitAll);

    // Gestos
    setupGesture(box1,1); setupGesture(box2,2);

    // ====== EXPORT 4:5 (1080x1350) ======
    downloadBtn.addEventListener('click', () => {
      const area = document.getElementById('exportArea');
      const scale = 1080 / area.clientWidth; // garante 1080px de largura
      html2canvas(area, { scale, backgroundColor: null, useCORS: true }).then(canvas => {
        const link = document.createElement('a'); link.download = 'fakex_4x5.png'; link.href = canvas.toDataURL('image/png'); link.click();
      });
    });

 

    // ====== Inicializa√ß√£o ======
    function init() {
      loadProfile(userSelect.value);
      tweetText.style.fontSize = fontSizeSelect.value;
      updateText();
      refreshMediaLayout();
    }
    init();
  </script>
</body>
</html>
